<html>
<head>
  <style>
   table {
     border: 1px solid black;
     border-collapse: collapse;
   }
   td, th {
     border: 1px solid black;
     border-collapse: collapse;
     padding-left: 10px;
     padding-right: 10px;
   }
   /* https://stackoverflow.com/questions/27525228/react-click-events-not-firing-on-mobile */
   table tr#gamesHeaderRow th {
     cursor: pointer;
   }
   #search, #search input {
     font-size: 25px;
   }
   #mondays, #fridays, #saturdays {
     float: left;
     padding: 20px;
   }

   #byDate {
     height: 200px;
     overflow: scroll;
   }

   #byDate span.play {
     display: inline-block;
     min-width: 80px;
   }
  </style>
  <script src="https://fb.me/react-0.13.0.js"></script>
  <script src="https://fb.me/JSXTransformer-0.13.0.js"></script>
<script type="text/jsx">
/** @jsx React.DOM */
var allGames = {{ allGames}};
var byDate = {{ byDate }};
// sort functions for sorting the game entries.
var RANK_SORT = function(a, b) { return a.ranking - b.ranking;};
var RATING_SORT = function(a, b) { return b.rating - a.rating;};
var NUM_RATINGS_SORT = function(a, b) { return b.numRatings - a.numRatings;};
var COMPLEXITY_SORT = function(a, b) { return a.complexity - b.complexity;};
var PLAYTIME_SORT = function(a, b) { return a.playTime - b.playTime;};
var NUM_PLAYS_SORT = function(a, b) { return b.numPlays - a.numPlays;};
var LAST_PLAYED_SORT = function(a, b) { 
  if (a.lastPlayed == null || a.lastPlayed == undefined) {
    if (b.lastPlayed != null && b.lastPlayed != undefined) {
      return 1;
    }
    if (b.lastPlayed == null || b.lastPlayed == undefined) {
      return 0;
    }
  }
  if (b.lastPlayed == null || b.lastPlayed == undefined) {
    return -1;
  }
  return new Date(b.lastPlayed) - new Date(a.lastPlayed);
};
var SingleGame = React.createClass({
  render: function() {
    var url = "https://www.boardgamegeek.com" + this.props.game.bggUrl;
    var aHref = <a href={url}>{this.props.game.name}</a>;
    var numPlays = this.props.game.numPlays == 0 ? "" : this.props.game.numPlays;
    return <tr>

        <td>{this.props.game.ranking}</td>
        <td>{aHref}</td>
        <td>{this.props.game.rating}</td>
        <td>{this.props.game.complexity}</td>
        <td>{this.props.game.playTime} mins</td>
        <td>{this.props.game.numRatings}</td>
        <td>{this.props.game.minNumPlayers} - {this.props.game.maxNumPlayers}</td>
        <td>{this.props.game.lastPlayed}</td>
        <td>{numPlays}</td>
        <td><RecordPlay gameId={this.props.game.bggId} offset="0" csrf={this.props.csrf}/></td>
      </tr>;
  }
});

var RecordPlay = React.createClass({

  render: function() {
    var dates = [];

    var today = new Date();
    for (var i = 0; i >= -30; i--) {
      var currDate = new Date(today);
      currDate.setDate(currDate.getDate() + i);
      var dateStr = (currDate.getMonth() + 1) + "/" + currDate.getDate() + "/" + currDate.getFullYear();
      var opt = <option value={dateStr}>{dateStr}</option>;
      dates.push(opt);
    }
    var sel = <select onChange={this.handleDateChange}>{dates}</select>;

    var sendBtn = <button className="sendBtn" onClick={this.handleSendClick}>Save</button>;
    return <span className="dateOptSpan">{sel}{sendBtn}</span>;

  },

  // Handles change of select option.
  handleDateChange: function(e) {
    this.setState({ dateSelected: e.target.value});
  },
  // Sends the play date to the backend to be saved.
  handleSendClick: function(e) {
    var self = this;
    var url = "/savePlay?csrfmiddlewaretoken=" + this.props.csrf;
    fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': this.props.csrf
        },
        body: JSON.stringify({gameId: self.props.gameId, date: self.state.dateSelected}) 
      })
    .then(res => console.log(res));
  }

});

var Home = React.createClass({
  getInitialState: function() {
    return { sortFn: RANK_SORT,
             numPlayersFilterNum: 0,
             games: this.props.allGames.sort(RANK_SORT) };
  },
  render: function() {
      var gameRows = [];
      //var filteredGames = this.filterGames(this.props.allGames);
      var sortedGames = this.state.games;
      for (var i = 0; i < sortedGames.length; i++) {

        var game = <SingleGame game={sortedGames[i]} key={sortedGames[i].bggId} csrf={this.props.csrf}/>
        gameRows.push(game);
        if (i > 500) {
          break;
        }
      }

      var search = <div id="search">Search <input type="text" onKeyUp={this.searchKeyUp}/></div>
      return <div id="homeDiv">{search}<br/>{this.formNumPlayersFilter()}<br/><br/>
        <table id="gamesTable"><tbody>
        <tr id="gamesHeaderRow">
          <th onClick={this.formChangeSortFn(RANK_SORT)} >Ranking</th>
          <th>Name</th>
          <th onClick={this.formChangeSortFn(RATING_SORT)}>Rating</th>
          <th onClick={this.formChangeSortFn(COMPLEXITY_SORT)} >Complexity</th>
          <th onClick={this.formChangeSortFn(PLAYTIME_SORT)}>Play Time</th>
          <th onClick={this.formChangeSortFn(NUM_RATINGS_SORT)} ># Ratings</th>
          <th># Players</th>
          <th onClick={this.formChangeSortFn(LAST_PLAYED_SORT)} >Last played</th>
          <th onClick={this.formChangeSortFn(NUM_PLAYS_SORT)}># Plays</th>
          <th></th>
        </tr>
       { gameRows}
       </tbody>
      </table>
      </div>;
  },

  // Forms the num players filter
  formNumPlayersFilter: function() {
    var options = [];
    for (var i = 0; i <= 12; i++) {
      var showVal = i == 0 ? "" : (i + "");
      var opt = <option value={i}>{showVal}</option>;
      options.push(opt);
    }
    return <div id="numPlayersFilter">
        Num Players:
        <select id="numPlayersSelect" onChange={this.handleNumPlayersFilterChange}>{options} </select>
      </div>;
  },

  formChangeSortFn: function(sortFn) {
    var self = this;
    return function(e) {
      self.setState({sortFn: sortFn,
                     games: self.state.games.sort(sortFn)});
    };
  },

  // Handle change num players filter - updates state.
  handleNumPlayersFilterChange: function(e) {
    var val = e.target.value;
    if (!val) {
      val = 0;
    }
    this.setState({ numPlayersFilterNum: val,
                    games: this.filterGames(this.props.allGames, this.state.searchKeyword, val)});
  },

  // Filters out games that don't meet certain criteria (stored in state) and
  // returns array of games that do match all the criteria.
  filterGames: function(games, keyword, numPlayersFilterNum) {
    var filtered = [];
    // do this here so don't have to call toLowerCase for every game
    if (keyword) {
      keyword = keyword.toLowerCase();
    }
    if ((!numPlayersFilterNum) && ((!keyword) || keyword.length == 1)) {
      return games;
    }
    for (var i = 0; i < games.length; i++) {
      if (this.matchesFilters(games[i], keyword, numPlayersFilterNum)) {
        filtered.push(games[i]);
      }
    }
    return filtered;
  },

  // Returns true if the game matches all current filters, false otherwise.
  matchesFilters: function(game, keyword, numPlayersFilter) {
    if (keyword && keyword.length > 1) {
      // if does not contain keyword, immediately return
      if (!game.lowername.includes(keyword)) {
        return false;
      }
    }

    if (numPlayersFilter > 0) {
      var matchesPlayers =
        game.minNumPlayers <= numPlayersFilter
        && numPlayersFilter <= game.maxNumPlayers;
      if (!matchesPlayers) {
        return false;
      }
    }
    
    return true;

  },

  // Handler for input in the search text field.
  searchKeyUp: function(e) {
    var oldKey = this.state.searchKeyword;
    var newKey = e.target.value;

    var games = this.props.allGames;
    if (oldKey && newKey) {
      // only need to filter already filtered ones
      if (newKey.startsWith(oldKey)) {
        games = this.state.games;
      }
    }
    games = this.filterGames(games, newKey, this.state.numPlayersFilterNum);
    this.setState({searchKeyword: e.target.value, games: games});
  },
});
var ByDate = React.createClass({
  render: function() {
    var byDate = {};
    // for each day in the week
    for (var i = 0; i < 7; i += 1) {

      var forDay = [];
      var playObjArr = this.props.byDate[i];
      // sort by date with most recent first
      playObjArr = playObjArr.sort(function(a, b) {
        return new Date(b["date"]) - new Date(a["date"]);
      });
      var prevDateStr = "";
      for (var j = 0; j < playObjArr.length; j += 1) {
        var name = this.findGameName(playObjArr[j]["bggId"]);
        var dateStr = playObjArr[j]["date"];
        // if same date as before, don't show date
        if (dateStr === prevDateStr) {
          dateStr = "";
        }
        var show = 
          <span>
            <span className="play">{dateStr}</span>
            <span className="gameName"> {name}</span>
          </span>;
        forDay.push(show);
        forDay.push(<br/>);
        prevDateStr = playObjArr[j]["date"]; // can't use dateStr since may be empty from above
      }
      byDate[i] = forDay;
    }   
    return  <div id="playsByDate">
       <div id="mondays"><b>Monday</b><br/>{byDate[0]}</div>
       <div id="fridays"><b>Friday</b><br/>{byDate[4]}</div>
       <div id="saturdays"><b>Saturday</b><br/>{byDate[5]}</div>
      </div>;

  },

  // returns the name of the game with the given id
  findGameName: function(id) {
    var name = "";
    for (var i = 0; i < this.props.allGames.length; i += 1) {
      if (id == this.props.allGames[i].bggId) {
        return this.props.allGames[i].name;
      }
    }

    return name;
  }
});

React.render(
  <Home allGames={allGames} csrf={document.getElementsByName("csrfmiddlewaretoken")[0].value}/>, document.getElementById("allGames"));
React.render(
  <ByDate allGames={allGames} byDate={byDate}csrf={document.getElementsByName("csrfmiddlewaretoken")[0].value}/>, document.getElementById("byDate"));
</script>
</head>
<body>
{% csrf_token %} 
<h1>Boardgames</h1>
<div id="byDate"></div>
<div id="allGames"></div>
<br/><br/><span>Data from www.boardgamegeek.com</span>
</body>
</html>
